function def(e){return"undefined"!=typeof e&&null!==e}function cr(e,t,i){var n=document.createElement(e);return def(t)&&(n.className=t),def(i)&&i.appendChild(n),n}function loadJson(e,t){var i=cr("script");i.onload=t,i.src=e,document.body.appendChild(i)}function saveState(){localStorage.state=JSON.stringify(STORAGE)}function loadState(){try{STORAGE=JSON.parse(localStorage.state)}catch(e){}}function inherit(e,t){return this._inherits&&-1==this._inherits.indexOf(e)?(e.apply(this,t),void this._inherits.push(e)):0}function getSelf(e){return e._inherits=e._inherits||[],e.inherit=inherit,e}function Parking(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Parking",t.init=function(){t.id=e,t.priority_by_tag={},t.slot_by_type={},PARKING[e]=t},t._getSlotByTag=function(e){var i=1/0,n=null;for(var o in t.slot_by_type){var a=t.slot_by_type[o],r=a.getPriorityFor(e);if(-1!=r){if(0==r)return a;(!n||i>r)&&(i=r,n=a)}}return n},t._getSlotByVehicle=function(e){for(var i=null,n=0;n<e.taglist.length;n++){var o=e.taglist[n];if(i=t._getSlotByTag(o))return i}return i},t.addSlots=function(e,i,n){t.slot_by_type[e]=new SlotSet({name:e,max:i,tagqueue:n})},t.register=function(e){var i=t._getSlotByVehicle(e);return i?(i.addVehicle(e),void t.saveState()):(console.log(locale.no_place_for,e),!1)},t.clear=function(e){for(var i in t.slot_by_type){var n=t.slot_by_type[i];n.clear()}t.saveState()},t._saveRepresintation=function(){var e={};for(var i in t.slot_by_type)e[i]=t.slot_by_type[i].getSerializedList();return e},t._loadRepresintation=function(e){for(var i in e)for(var n=e[i].split(","),o=0;o<n.length;o++){var a=VEHICLE[n[o]];a&&t.slot_by_type[i]&&t.slot_by_type[i].addVehicle(a,o)}},t.yieldState=function(){for(k in t.slot_by_type)console.log(["\n",locale.state_parking_group[0]," ",k," ",locale.state_parking_group[1]].join("")),t.slot_by_type[k].yieldState()},t._createDom=function(){t.dom=cr("div","parking");for(k in t.slot_by_type)t.dom.appendChild(t.slot_by_type[k].getDom());return t.dom},t.getDom=function(){return t.dom||t._createDom()},t.init()}function SlotSet(e){var t=getSelf(this);t.inherit(BaseModel),t.init=function(){t.name=e.name,t.has=0,t.max=e.max||0,t.tagqueue=e.tagqueue||[],t.vehicles=new Array(t.max),t.vehicles_dom=new Array(t.max),t._createDom()},t.addVehicle=function(e,i){if(t.has==t.max)return!1;if(!def(i))for(i=0;void 0!=t.vehicles[i];i++);t.vehicles[i]=e,t.has+=1,e._delete.slot=function(){t.removeVehicle(e)},e.addondelete(e._delete.slot),t.vehicles_dom[i].appendChild(e.getDom()),t.fetchString()},t.removeVehicle=function(e){var i=t.vehicles.indexOf(e);-1!=i&&(delete t.vehicles[i],t.has-=1,e.removeondelete(e._delete.slot),t.vehicles_dom[i].textContent="",t.fetchString())},t.getPriorityFor=function(e){return t.has==t.max?-1:t.tagqueue.indexOf(e)},t.yieldState=function(){console.log([locale.filled_with_vehicles[0]," ",t.has,"/",t.max," ",locale.filled_with_vehicles[1],": {"].join(""));for(var e=0;e<t.max;e++){var i=t.vehicles[e];void 0==i?console.log("	---------"):console.log(["	",i.id," ",i.taglist.join(", ")].join(""))}console.log("}")},t.getSerializedList=function(){return t.vehicles.join(",")},t.clear=function(){for(var e=0;e<t.max;e++){var i=t.vehicles[e];i&&i["delete"]()}t.vehicles=new Array(t.max),t.has=0},t._createDom=function(){t.dom=cr("div","slot-set"),t.textlabel=cr("div","slot-name",t.dom),t.fetchString();for(var e=0;e<t.max;e++)t.vehicles_dom[e]=cr("div","slot",t.dom);return t.dom},t.fetchString=function(){t.textlabel.textContent=[t.name," ",t.has,"/",t.max].join("")},t.getDom=function(){return t.dom},t.init()}function Tag(e){this.name=e,TAG[e]=this}function toLen(e,t){return new Array(t-e.length+1).join("0")+e}function Vehicle(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Vehicle",t.init=function(i){return t.id=i||[config.vehicle_id_prefix,carIter.get()].join("-"),t.taglist=t._normalizeTags(e),VEHICLE[t.id]=t,t.saveState(),t},t._normalizeTags=function(e){if(e=e||[],"string"==typeof e){var t=e.split(",");e=[];for(var i=0;i<t.length;i++)e.push(TAG[t[i]])}return e},t.copy=function(){return new Vehicle(e.slice()).init()},t._saveRepresintation=function(){return{taglist:t.taglist.join(",")}},t._createDom=function(){var e=t.taglist.join(" ");return t.dom=cr("div","vehicle "+e),t.textlabel=cr("div","label",t.dom),t.textlabel.textContent=[t.id,e].join(" "),t.dom},t.getDom=function(){return t.dom||t._createDom()}}function fixtureFillScenario(e,t){e=e||1,t=t||Object.keys(TAG);for(var i=0;e>i;i++){var n=TAG[t[parseInt(Math.random()*t.length)]];parking.register(new Vehicle([n]).init())}}function fixtureContiniousFillScenario(e,t){e=e||1;var i=e-config.fixtureFill.random;if(i<=config.fixtureFill.random)return console.log([locale.fixture_fill_need[0],2*config.fixtureFill.random+1,locale.fixture_fill_need[1]].join(" ")),0;parking.clear();var n=0,o=function(){if(i>n)fixtureFillScenario(i-n+Math.floor(Math.random()*config.fixtureFill.random),t);else for(var e=n-i+Math.floor(Math.random()*config.fixtureFill.random),o=0;e>o;o++){var a=Object.keys(VEHICLE);VEHICLE[a[Math.floor(Math.random()*a.length)]]["delete"]()}n=Object.keys(VEHICLE).length};clearInterval(window._ffInt),window._ffInt=setInterval(o,config.fixtureFill.interval)}function migrate(){delete localStorage.state,window.location.reload()}function migration_check(){var e=localStorage.db_version||0;localStorage.db_version=config.version.db,e!=config.version.db&&migrate()}function declareInstances(){"Truck,Sedan,Disabled".split(",").map(function(e){new Tag(e)}),window.parking=new Parking("main"),parking.addSlots("Trucks",10,[TAG.Truck,null,TAG.Disabled,TAG.Sedan]),parking.addSlots("Disabled",5,[TAG.Disabled]),parking.addSlots("Simple",15,[TAG.Sedan,TAG.Disabled]),window.dummy_Truck=new Vehicle([TAG.Truck]).init("DV-truck"),window.dummy_Sedan=new Vehicle([TAG.Sedan]).init("DV-sedan"),window.dummy_Disabled=new Vehicle([TAG.Disabled]).init("DV-disabled")}function mainScenario(){migration_check(),window.loadState(),declareInstances(),Vehicle.loadState(),Parking.loadState(),parking.yieldState();var e=parking.getDom();document.body.appendChild(e)}window.STORAGE={};var BaseModel=function(){function e(e){this._delete.todo.push(e)}function t(e){var t=this._delete.todo.indexOf(e);-1!=t&&this._delete.todo.splice(t,1)}function i(){for(var e=0;e<this._delete.todo.length;e++)this._delete.todo[e]();this._delete.todo=[]}function n(){if(this.model&&this.id){var e=this.model.toUpperCase();window[e]&&window[e][this.id]&&delete window[e][this.id],STORAGE[this.model]&&STORAGE[this.model][this.id]&&delete STORAGE[this.model][this.id]}this.doondelete()}function o(){this._deleteworker(),window.saveState()}function a(){return{}}function r(e){}function l(){this.model&&this.id&&(STORAGE[this.model]=STORAGE[this.model]||{},STORAGE[this.model][this.id]=this._saveRepresintation()),window.saveState()}function d(){this.model&&this.id&&STORAGE[this.model]&&STORAGE[this.model][this.id]&&this._loadRepresintation(STORAGE[this.model][this.id])}return function(){this._delete={todo:[]},this.addondelete=e,this.removeondelete=t,this.doondelete=i,this._deleteworker=n,this["delete"]=o,this._saveRepresintation=a,this._loadRepresintation=r,this.saveState=l,this.loadState=d}}();BaseModel.ModelSaveStateMechanics=function(e){return function(){for(var t in e)e[t].saveState()}},BaseModel.ModelLoadStateMechanics=function(e){return function(){for(var t in e)e[t].loadState()}},window.PARKING={},Parking.saveState=BaseModel.ModelSaveStateMechanics(PARKING),Parking.loadState=BaseModel.ModelLoadStateMechanics(PARKING),window.TAG={},Tag.prototype.toString=function(){return this.name},Tag.fetch=function(e){return TAG[e]||new Tag(e)},window.carIter={get:function(){var e=STORAGE.carId||41;return e+=1,STORAGE.carId=e,toLen(e.toString(),4)}},window.VEHICLE={},Vehicle.prototype.toString=function(){return this.id},Vehicle.saveState=BaseModel.ModelSaveStateMechanics(VEHICLE),Vehicle.loadState=function(){for(var e in STORAGE.Vehicle)new Vehicle(STORAGE.Vehicle[e].taglist).init(e)},loadJson("config.json",function(){loadJson(["locale/",config.locale,".json"].join(""),mainScenario)});