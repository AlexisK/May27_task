function def(e){return"undefined"!=typeof e&&null!==e}function cr(e,t,n){var i=document.createElement(e);return def(t)&&(i.className=t),def(n)&&n.appendChild(i),i}function loadJson(e,t){var n=cr("script");n.onload=t,n.src=e,document.body.appendChild(n)}function saveState(){localStorage.state=JSON.stringify(STORAGE)}function loadState(){try{STORAGE=JSON.parse(localStorage.state)}catch(e){}}function inherit(e,t){return this._inherits&&-1==this._inherits.indexOf(e)?(e.apply(this,t),void this._inherits.push(e)):0}function getSelf(e){return e._inherits=e._inherits||[],e.inherit=inherit,e}function BaseModel(){var e=getSelf(this);e._delete={todo:[]},e.addondelete=function(t){e._delete.todo.push(t)},e.removeondelete=function(t){var n=e._delete.todo.indexOf(t);-1!=n&&e._delete.todo.splice(n,1)},e.doondelete=function(){for(var t=0;t<e._delete.todo.length;t++)e._delete.todo[t]();e._delete.todo=[]},e._deleteworker=function(){if(e.model&&e.id){var t=e.model.toUpperCase();window[t]&&window[t][e.id]&&delete window[t][e.id],STORAGE[e.model]&&STORAGE[e.model][e.id]&&delete STORAGE[e.model][e.id]}e.doondelete()},e["delete"]=function(){e._deleteworker(),window.saveState()},e._saveRepresintation=function(){return{}},e._loadRepresintation=function(e){},e.saveState=function(){e.model&&e.id&&(STORAGE[e.model]=STORAGE[e.model]||{},STORAGE[e.model][e.id]=e._saveRepresintation()),window.saveState()},e.loadState=function(){e.model&&e.id&&STORAGE[e.model]&&STORAGE[e.model][e.id]&&e._loadRepresintation(STORAGE[e.model][e.id])}}function Parking(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Parking",t.init=function(){t.id=e,t.priority_by_tag={},t.slot_by_type={},PARKING[e]=t},t._getSlotByTag=function(e){var n=1/0,i=null;for(var o in t.slot_by_type){var a=t.slot_by_type[o],r=a.getPriorityFor(e);if(-1!=r){if(0==r)return a;(!i||n>r)&&(n=r,i=a)}}return i},t._getSlotByVehicle=function(e){for(var n=null,i=0;i<e.taglist.length;i++){var o=e.taglist[i];if(n=t._getSlotByTag(o))return n}return n},t.addSlots=function(e,n,i){t.slot_by_type[e]=new SlotSet({name:e,max:n,tagqueue:i})},t.register=function(e){var n=t._getSlotByVehicle(e);return n?(n.addVehicle(e),void t.saveState()):(console.log(locale.no_place_for,e),!1)},t.clear=function(e){for(var n in t.slot_by_type){var i=t.slot_by_type[n];i.clear()}t.saveState()},t._saveRepresintation=function(){var e={};for(var n in t.slot_by_type)e[n]=t.slot_by_type[n].getSerializedList();return e},t._loadRepresintation=function(e){for(var n in e)for(var i=e[n].split(","),o=0;o<i.length;o++){var a=VEHICLE[i[o]];a&&t.slot_by_type[n]&&t.slot_by_type[n].addVehicle(a,o)}},t.yieldState=function(){for(k in t.slot_by_type)console.log(["\n",locale.state_parking_group[0]," ",k," ",locale.state_parking_group[1]].join("")),t.slot_by_type[k].yieldState()},t._createDom=function(){t.dom=cr("div","parking");for(k in t.slot_by_type)t.dom.appendChild(t.slot_by_type[k].getDom());return t.dom},t.getDom=function(){return t.dom||t._createDom()},t.init()}function SlotSet(e){var t=getSelf(this);t.inherit(BaseModel),t.init=function(){t.name=e.name,t.has=0,t.max=e.max||0,t.tagqueue=e.tagqueue||[],t.vehicles=new Array(t.max),t.vehicles_dom=new Array(t.max),t._createDom()},t.addVehicle=function(e,n){if(t.has==t.max)return!1;if(!def(n))for(n=0;void 0!=t.vehicles[n];n++);t.vehicles[n]=e,t.has+=1,e._delete.slot=function(){t.removeVehicle(e)},e.addondelete(e._delete.slot),t.vehicles_dom[n].appendChild(e.getDom()),t.fetchString()},t.removeVehicle=function(e){var n=t.vehicles.indexOf(e);-1!=n&&(delete t.vehicles[n],t.has-=1,e.removeondelete(e._delete.slot),t.vehicles_dom[n].textContent="",t.fetchString())},t.getPriorityFor=function(e){return t.has==t.max?-1:t.tagqueue.indexOf(e)},t.yieldState=function(){console.log([locale.filled_with_vehicles[0]," ",t.has,"/",t.max," ",locale.filled_with_vehicles[1],": {"].join(""));for(var e=0;e<t.max;e++){var n=t.vehicles[e];void 0==n?console.log("	---------"):console.log(["	",n.id," ",n.taglist.join(", ")].join(""))}console.log("}")},t.getSerializedList=function(){return t.vehicles.join(",")},t.clear=function(){for(var e=0;e<t.max;e++){var n=t.vehicles[e];n&&n["delete"]()}t.vehicles=new Array(t.max),t.has=0},t._createDom=function(){t.dom=cr("div","slot-set"),t.textlabel=cr("div","slot-name",t.dom),t.fetchString();for(var e=0;e<t.max;e++)t.vehicles_dom[e]=cr("div","slot",t.dom);return t.dom},t.fetchString=function(){t.textlabel.textContent=[t.name," ",t.has,"/",t.max].join("")},t.getDom=function(){return t.dom},t.init()}function Tag(e){this.name=e,TAG[e]=this}function toLen(e,t){return new Array(t-e.length+1).join("0")+e}function Vehicle(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Vehicle",t.init=function(n){return t.id=n||[config.vehicle_id_prefix,carIter.get()].join("-"),t.taglist=t._normalizeTags(e),VEHICLE[t.id]=t,t.saveState(),t},t._normalizeTags=function(e){if(e=e||[],"string"==typeof e){var t=e.split(",");e=[];for(var n=0;n<t.length;n++)e.push(TAG[t[n]])}return e},t.copy=function(){return new Vehicle(e.slice()).init()},t._saveRepresintation=function(){return{taglist:t.taglist.join(",")}},t._createDom=function(){var e=t.taglist.join(" ");return t.dom=cr("div","vehicle "+e),t.textlabel=cr("div","label",t.dom),t.textlabel.textContent=[t.id,e].join(" "),t.dom},t.getDom=function(){return t.dom||t._createDom()}}function fixtureFillScenario(e,t){e=e||1,t=t||Object.keys(TAG);for(var n=0;e>n;n++){var i=TAG[t[parseInt(Math.random()*t.length)]];parking.register(new Vehicle([i]).init())}}function fixtureContiniousFillScenario(e,t){e=e||1;var n=e-config.fixtureFill.random;if(n<=config.fixtureFill.random)return console.log([locale.fixture_fill_need[0],2*config.fixtureFill.random+1,locale.fixture_fill_need[1]].join(" ")),0;parking.clear();var i=0,o=function(){if(n>i)fixtureFillScenario(n-i+Math.floor(Math.random()*config.fixtureFill.random),t);else for(var e=i-n+Math.floor(Math.random()*config.fixtureFill.random),o=0;e>o;o++){var a=Object.keys(VEHICLE);VEHICLE[a[Math.floor(Math.random()*a.length)]]["delete"]()}i=Object.keys(VEHICLE).length};clearInterval(window._ffInt),window._ffInt=setInterval(o,config.fixtureFill.interval)}function migrate(){delete localStorage.state,window.location.reload()}function migration_check(){var e=localStorage.db_version||0;localStorage.db_version=config.version.db,e!=config.version.db&&migrate()}function declareInstances(){"Truck,Sedan,Disabled".split(",").map(function(e){new Tag(e)}),window.parking=new Parking("main"),parking.addSlots("Trucks",10,[TAG.Truck,null,TAG.Disabled,TAG.Sedan]),parking.addSlots("Disabled",5,[TAG.Disabled]),parking.addSlots("Simple",15,[TAG.Sedan,TAG.Disabled]),window.dummy_Truck=new Vehicle([TAG.Truck]).init("DV-truck"),window.dummy_Sedan=new Vehicle([TAG.Sedan]).init("DV-sedan"),window.dummy_Disabled=new Vehicle([TAG.Disabled]).init("DV-disabled")}function mainScenario(){migration_check(),window.loadState(),declareInstances(),Vehicle.loadState(),Parking.loadState(),parking.yieldState();var e=parking.getDom();document.body.appendChild(e)}window.STORAGE={},BaseModel.ModelSaveStateMechanics=function(e){return function(){for(var t in e)e[t].saveState()}},BaseModel.ModelLoadStateMechanics=function(e){return function(){for(var t in e)e[t].loadState()}},window.PARKING={},Parking.saveState=BaseModel.ModelSaveStateMechanics(PARKING),Parking.loadState=BaseModel.ModelLoadStateMechanics(PARKING),window.TAG={},Tag.prototype.toString=function(){return this.name},Tag.fetch=function(e){return TAG[e]||new Tag(e)},window.carIter={get:function(){var e=STORAGE.carId||41;return e+=1,STORAGE.carId=e,toLen(e.toString(),4)}},window.VEHICLE={},Vehicle.prototype.toString=function(){return this.id},Vehicle.saveState=BaseModel.ModelSaveStateMechanics(VEHICLE),Vehicle.loadState=function(){for(var e in STORAGE.Vehicle)new Vehicle(STORAGE.Vehicle[e].taglist).init(e)},loadJson("config.json",function(){loadJson(["locale/",config.locale,".json"].join(""),mainScenario)});