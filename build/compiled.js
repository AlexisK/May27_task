function def(e){return"undefined"!=typeof e&&null!==e}function saveState(){localStorage.state=JSON.stringify(STORAGE)}function loadState(){try{STORAGE=JSON.parse(localStorage.state)}catch(e){}}function inherit(e,t){return this._inherits&&-1==this._inherits.indexOf(e)?(e.apply(this,t),void this._inherits.push(e)):0}function getSelf(e){return e._inherits=e._inherits||[],e.inherit=inherit,e}function BaseModel(){var e=getSelf(this);e._delete={todo:[]},e.addondelete=function(t){e._delete.todo.push(t)},e.removeondelete=function(t){var i=e._delete.todo.indexOf(t);-1!=i&&e._delete.todo.splice(i,1)},e.doondelete=function(){for(var t=0;t<e._delete.todo.length;t++)e._delete.todo[t]();e._delete.todo=[]},e._deleteworker=function(){if(e.model&&e.id){var t=e.model.toUpperCase();window[t]&&window[t][e.id]&&delete window[t][e.id],STORAGE[e.model]&&STORAGE[e.model][e.id]&&delete STORAGE[e.model][e.id]}e.doondelete()},e["delete"]=function(){e._deleteworker(),window.saveState()},e._saveRepresintation=function(){return{}},e._loadRepresintation=function(e){},e.saveState=function(){e.model&&e.id&&(STORAGE[e.model]=STORAGE[e.model]||{},STORAGE[e.model][e.id]=e._saveRepresintation()),window.saveState()},e.loadState=function(){e.model&&e.id&&STORAGE[e.model]&&STORAGE[e.model][e.id]&&e._loadRepresintation(STORAGE[e.model][e.id])}}function Parking(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Parking",t.init=function(){t.id=e,t.priority_by_tag={},t.slot_by_type={},PARKING[e]=t},t._getSlotByTag=function(e){var i=1/0,n=null;for(var o in t.slot_by_type){var a=t.slot_by_type[o],l=a.getPriorityFor(e);if(-1!=l){if(0==l)return a;(!n||i>l)&&(i=l,n=a)}}return n},t._getSlotByVehicle=function(e){for(var i=null,n=0;n<e.taglist.length;n++){var o=e.taglist[n];if(i=t._getSlotByTag(o))return i}return i},t.addSlots=function(e,i,n){t.slot_by_type[e]=new SlotSet({max:i,tagqueue:n})},t.register=function(e){var i=t._getSlotByVehicle(e);return i?(i.addVehicle(e),void t.saveState()):(console.log("No place for ",e),!1)},t.clear=function(e){for(var i in t.slot_by_type){var n=t.slot_by_type[i];n.clear()}t.saveState()},t._saveRepresintation=function(){var e={};for(var i in t.slot_by_type)e[i]=t.slot_by_type[i].getSerializedList();return e},t._loadRepresintation=function(e){for(var i in e)for(var n=e[i].split(","),o=0;o<n.length;o++){var a=VEHICLE[n[o]];a&&t.slot_by_type[i].addVehicle(a,o)}},t.yieldState=function(){for(k in t.slot_by_type)console.log(["\nState for ",k," parking group"].join("")),t.slot_by_type[k].yieldState()},t.init()}function SlotSet(e){var t=getSelf(this);t.inherit(BaseModel),t.init=function(){t.has=0,t.max=e.max||0,t.tagqueue=e.tagqueue||[],t.vehicles=new Array(t.max)},t.addVehicle=function(e,i){if(t.has==t.max)return!1;if(!def(i))for(i=0;void 0!=t.vehicles[i];i++);t.vehicles[i]=e,t.has+=1,e._delete.slot=function(){t.removeVehicle(e)},e.addondelete(e._delete.slot)},t.removeVehicle=function(e){var i=t.vehicles.indexOf(e);-1!=i&&(delete t.vehicles[i],t.has-=1,e.removeondelete(e._delete.slot))},t.getPriorityFor=function(e){return t.has==t.max?-1:t.tagqueue.indexOf(e)},t.yieldState=function(){console.log(["Currently filled with ",t.has,"/",t.max," vehicles: {"].join(""));for(var e=0;e<t.vehicles.length;e++){var i=t.vehicles[e];void 0==i?console.log("	---------"):console.log(["	",i.id," ",i.taglist.join(", ")].join(""))}console.log("}")},t.getSerializedList=function(){return t.vehicles.join(",")},t.clear=function(){for(var e=0;e<t.vehicles.length;e++){var i=t.vehicles[e];i&&i["delete"]()}t.vehicles=new Array(t.max),t.has=0},t.init()}function Tag(e){this.name=e,TAG[e]=this}function toLen(e,t){return new Array(t-e.length+1).join("0")+e}function Vehicle(e){var t=getSelf(this);t.inherit(BaseModel),t.model="Vehicle",t.init=function(i){return t.id=i||"VH-"+carIter.get(),t.taglist=t._normalizeTags(e),VEHICLE[t.id]=t,t.saveState(),t},t._normalizeTags=function(e){if(e=e||[],"string"==typeof e){var t=e.split(",");e=[];for(var i=0;i<t.length;i++)e.push(TAG[t[i]])}return e},t.copy=function(){return new Vehicle(e.slice()).init()},t._saveRepresintation=function(){return{taglist:t.taglist.join(",")}}}function declareInstances(){"Truck,Sedan,Disabled".split(",").map(function(e){new Tag(e)}),window.parking=new Parking("main"),parking.addSlots("Trucks",10,[TAG.Truck,null,TAG.Disabled,TAG.Sedan]),parking.addSlots("Disabled",5,[TAG.Disabled]),parking.addSlots("Simple",15,[TAG.Sedan,TAG.Disabled]),window.dummy_Truck=new Vehicle([TAG.Truck]).init("DV-truck"),window.dummy_Sedan=new Vehicle([TAG.Sedan]).init("DV-sedan"),window.dummy_Disabled=new Vehicle([TAG.Disabled]).init("DV-disabled")}function mainScenario(){window.loadState(),declareInstances(),Vehicle.loadState(),Parking.loadState(),parking.yieldState()}function fixtureFillScenario(e){e=e||0;for(var t=Object.keys(TAG),i=0;e>i;i++){var n=TAG[t[parseInt(Math.random()*t.length)]];parking.register(new Vehicle([n]).init())}}function migrate(){delete localStorage.state,window.location.reload()}window.STORAGE={},BaseModel.ModelSaveStateMechanics=function(e){return function(){for(var t in e)e[t].saveState()}},BaseModel.ModelLoadStateMechanics=function(e){return function(){for(var t in e)e[t].loadState()}},window.PARKING={},Parking.saveState=BaseModel.ModelSaveStateMechanics(PARKING),Parking.loadState=BaseModel.ModelLoadStateMechanics(PARKING),window.TAG={},Tag.prototype.toString=function(){return this.name},Tag.fetch=function(e){return TAG[e]||new Tag(e)},window.carIter={num:41,get:function(){return toLen((carIter.num+=1).toString(),4)}},window.VEHICLE={},Vehicle.prototype.toString=function(){return this.id},Vehicle.saveState=BaseModel.ModelSaveStateMechanics(VEHICLE),Vehicle.loadState=function(){for(var e in STORAGE.Vehicle)new Vehicle(STORAGE.Vehicle[e].taglist).init(e)},mainScenario();