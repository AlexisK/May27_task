function def(t){return"undefined"!=typeof t&&null!==t}function cr(t,e,i){var n=document.createElement(t);return def(e)&&(n.className=e),def(i)&&i.appendChild(n),n}function loadJson(t,e){var i=cr("script");i.onload=e,i.src=t,document.body.appendChild(i)}function saveState(){localStorage.state=JSON.stringify(STORAGE)}function loadState(){try{STORAGE=JSON.parse(localStorage.state)}catch(t){}}function inherit(t,e){return this._inherits&&-1==this._inherits.indexOf(t)?(t.apply(this,e),void this._inherits.push(t)):0}function getSelf(t){return t._inherits=t._inherits||[],t.inherit=inherit,t}function Tag(t){this.name=t,TAG[t]=this}function toLen(t,e){return new Array(e-t.length+1).join("0")+t}function fixtureFillScenario(t,e){t=t||1,e=e||Object.keys(TAG);for(var i=0;t>i;i++){var n=TAG[e[parseInt(Math.random()*e.length)]];parking.register(new Vehicle([n]).init())}}function fixtureContiniousFillScenario(t,e){t=t||1;var i=t-config.fixtureFill.random;if(i<=config.fixtureFill.random)return console.log([locale.fixture_fill_need[0],2*config.fixtureFill.random+1,locale.fixture_fill_need[1]].join(" ")),0;parking.clear();var n=0,o=function(){if(i>n)fixtureFillScenario(i-n+Math.floor(Math.random()*config.fixtureFill.random),e);else for(var t=n-i+Math.floor(Math.random()*config.fixtureFill.random),o=0;t>o;o++){var a=Object.keys(VEHICLE);VEHICLE[a[Math.floor(Math.random()*a.length)]]["delete"]()}n=Object.keys(VEHICLE).length};clearInterval(window._ffInt),window._ffInt=setInterval(o,config.fixtureFill.interval)}function migrate(){delete localStorage.state,window.location.reload()}function migration_check(){var t=localStorage.db_version||0;localStorage.db_version=config.version.db,t!=config.version.db&&migrate()}function declareInstances(){"Truck,Sedan,Disabled".split(",").map(function(t){new Tag(t)}),window.parking=new Parking("main"),parking.addSlots("Trucks",10,[TAG.Truck,null,TAG.Disabled,TAG.Sedan]),parking.addSlots("Disabled",5,[TAG.Disabled]),parking.addSlots("Simple",15,[TAG.Sedan,TAG.Disabled]),window.dummy_Truck=new Vehicle([TAG.Truck]).init("DV-truck"),window.dummy_Sedan=new Vehicle([TAG.Sedan]).init("DV-sedan"),window.dummy_Disabled=new Vehicle([TAG.Disabled]).init("DV-disabled")}function mainScenario(){migration_check(),window.loadState(),declareInstances(),Vehicle.loadState(),Parking.loadState(),parking.yieldState();var t=parking.getDom();document.body.appendChild(t)}window.STORAGE={};var BaseModel=function(){function t(t){this._delete.todo.push(t)}function e(t){var e=this._delete.todo.indexOf(t);-1!=e&&this._delete.todo.splice(e,1)}function i(){for(var t=0;t<this._delete.todo.length;t++)this._delete.todo[t]();this._delete.todo=[]}function n(){if(this.model&&this.id){var t=this.model.toUpperCase();window[t]&&window[t][this.id]&&delete window[t][this.id],STORAGE[this.model]&&STORAGE[this.model][this.id]&&delete STORAGE[this.model][this.id]}this.doondelete()}function o(){this._deleteworker(),window.saveState()}function a(){return{}}function r(t){}function s(){this.model&&this.id&&(STORAGE[this.model]=STORAGE[this.model]||{},STORAGE[this.model][this.id]=this._saveRepresintation()),window.saveState()}function l(){this.model&&this.id&&STORAGE[this.model]&&STORAGE[this.model][this.id]&&this._loadRepresintation(STORAGE[this.model][this.id])}return function(){this._delete={todo:[]},this.addondelete=t,this.removeondelete=e,this.doondelete=i,this._deleteworker=n,this["delete"]=o,this._saveRepresintation=a,this._loadRepresintation=r,this.saveState=s,this.loadState=l}}();BaseModel.ModelSaveStateMechanics=function(t){return function(){for(var e in t)t[e].saveState()}},BaseModel.ModelLoadStateMechanics=function(t){return function(){for(var e in t)t[e].loadState()}},window.PARKING={};var Parking=function(){function t(t){this.id=t,this.priority_by_tag={},this.slot_by_type={},PARKING[t]=this}function e(t){var e=1/0,i=null;for(var n in this.slot_by_type){var o=this.slot_by_type[n],a=o.getPriorityFor(t);if(-1!=a){if(0==a)return o;(!i||e>a)&&(e=a,i=o)}}return i}function i(t){for(var e=null,i=0;i<t.taglist.length;i++){var n=t.taglist[i];if(e=this._getSlotByTag(n))return e}return e}function n(t,e,i){this.slot_by_type[t]=new SlotSet({name:t,max:e,tagqueue:i})}function o(t){var e=this._getSlotByVehicle(t);return e?(e.addVehicle(t),void this.saveState()):(console.log(locale.no_place_for,t),!1)}function a(t){for(var e in this.slot_by_type){var i=this.slot_by_type[e];i.clear()}this.saveState()}function r(){var t={};for(var e in this.slot_by_type)t[e]=this.slot_by_type[e].getSerializedList();return t}function s(t){for(var e in t)for(var i=t[e].split(","),n=0;n<i.length;n++){var o=VEHICLE[i[n]];o&&this.slot_by_type[e]&&this.slot_by_type[e].addVehicle(o,n)}}function l(){for(k in this.slot_by_type)console.log(["\n",locale.state_parking_group[0]," ",k," ",locale.state_parking_group[1]].join("")),this.slot_by_type[k].yieldState()}function h(){this.dom=cr("div","parking");for(k in this.slot_by_type)this.dom.appendChild(this.slot_by_type[k].getDom());return this.dom}function d(){return this.dom||this._createDom()}return function(c){var f=getSelf(this);f.inherit(BaseModel),f.model="Parking",f.init=t,f._getSlotByTag=e,f._getSlotByVehicle=i,f.addSlots=n,f.register=o,f.clear=a,f._saveRepresintation=r,f._loadRepresintation=s,f.yieldState=l,f._createDom=h,f.getDom=d,f.init(c)}}();Parking.saveState=BaseModel.ModelSaveStateMechanics(PARKING),Parking.loadState=BaseModel.ModelLoadStateMechanics(PARKING);var SlotSet=function(){function t(t){this.name=t.name,this.has=0,this.max=t.max||0,this.tagqueue=t.tagqueue||[],this.vehicles=new Array(this.max),this.vehicles_dom=new Array(this.max),this._createDom()}function e(t,e){var i=this;if(this.has==this.max)return!1;if(!def(e))for(e=0;void 0!=this.vehicles[e];e++);this.vehicles[e]=t,this.has+=1,t._delete.slot=function(){i.removeVehicle(t)},t.addondelete(t._delete.slot),this.vehicles_dom[e].appendChild(t.getDom()),this.fetchString()}function i(t){var e=this.vehicles.indexOf(t);-1!=e&&(delete this.vehicles[e],this.has-=1,t.removeondelete(t._delete.slot),this.vehicles_dom[e].textContent="",this.fetchString())}function n(t){return this.has==this.max?-1:this.tagqueue.indexOf(t)}function o(){console.log([locale.filled_with_vehicles[0]," ",this.has,"/",this.max," ",locale.filled_with_vehicles[1],": {"].join(""));for(var t=0;t<this.max;t++){var e=this.vehicles[t];void 0==e?console.log("	---------"):console.log(["	",e.id," ",e.taglist.join(", ")].join(""))}console.log("}")}function a(){return this.vehicles.join(",")}function r(){for(var t=0;t<this.max;t++){var e=this.vehicles[t];e&&e["delete"]()}this.vehicles=new Array(this.max),this.has=0}function s(){this.dom=cr("div","slot-set"),this.textlabel=cr("div","slot-name",this.dom),this.fetchString();for(var t=0;t<this.max;t++)this.vehicles_dom[t]=cr("div","slot",this.dom);return this.dom}function l(){this.textlabel.textContent=[this.name," ",this.has,"/",this.max].join("")}function h(){return this.dom}return function(d){var c=getSelf(this);c.inherit(BaseModel),c.init=t,c.addVehicle=e,c.removeVehicle=i,c.getPriorityFor=n,c.yieldState=o,c.getSerializedList=a,c.clear=r,c._createDom=s,c.fetchString=l,c.getDom=h,c.init(d)}}();window.TAG={},Tag.prototype.toString=function(){return this.name},Tag.fetch=function(t){return TAG[t]||new Tag(t)},window.carIter={get:function(){var t=STORAGE.carId||41;return t+=1,STORAGE.carId=t,toLen(t.toString(),4)}},window.VEHICLE={};var Vehicle=function(){function t(t){return this.id=t||[config.vehicle_id_prefix,carIter.get()].join("-"),VEHICLE[this.id]=this,this.saveState(),this}function e(t){if(t=t||[],"string"==typeof t){var e=t.split(",");t=[];for(var i=0;i<e.length;i++)t.push(TAG[e[i]])}return t}function i(){return new Vehicle(taglist.slice()).init()}function n(){return{taglist:this.taglist.join(",")}}function o(){var t=this.taglist.join(" ");return this.dom=cr("div","vehicle "+t),this.textlabel=cr("div","label",this.dom),this.textlabel.textContent=[this.id,t].join(" "),this.dom}function a(){return this.dom||this._createDom()}return function(r){var s=getSelf(this);s.inherit(BaseModel),s.model="Vehicle",s.init=t,s._normalizeTags=e,s.copy=i,s._saveRepresintation=n,s._createDom=o,s.getDom=a,s.taglist=s._normalizeTags(r)}}();Vehicle.prototype.toString=function(){return this.id},Vehicle.saveState=BaseModel.ModelSaveStateMechanics(VEHICLE),Vehicle.loadState=function(){for(var t in STORAGE.Vehicle)new Vehicle(STORAGE.Vehicle[t].taglist).init(t)},loadJson("config.json",function(){loadJson(["locale/",config.locale,".json"].join(""),mainScenario)});